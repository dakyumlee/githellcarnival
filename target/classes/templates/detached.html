<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>🧑‍🦲 Detached HEAD 대탈출</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/arcade.css">
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Pretendard, sans-serif;
      margin: 0;
      overflow: hidden;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin: 10px 0;
      color: #fff;
    }

    .sub {
      text-align: center;
      color: #bbb;
      margin-bottom: 15px;
    }

    .game-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 15px 0;
    }

    .control-panel {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .score-display {
      font-size: 24px;
      font-weight: bold;
      color: #6ea8ff;
    }

    .lives-display {
      font-size: 20px;
      color: #e74c3c;
    }

    .level-display {
      font-size: 18px;
      color: #f39c12;
    }

    .game-area {
      position: relative;
      flex: 1;
      background: #1a1a2e;
      border: 2px solid #333;
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0;
      min-height: 400px;
    }

    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #2a2a2a;
      border-top: 2px solid #444;
    }

    .head-player {
      position: absolute;
      bottom: 60px;
      left: 100px;
      font-size: 48px;
      transition: bottom 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 10;
    }

    .head-jumping {
      bottom: 180px !important;
    }

    .branch {
      position: absolute;
      bottom: 60px;
      font-size: 36px;
      color: #2ecc71;
    }

    .obstacle {
      position: absolute;
      bottom: 60px;
      font-size: 32px;
      color: #e74c3c;
    }

    .power-up {
      position: absolute;
      bottom: 120px;
      font-size: 28px;
      color: #f39c12;
    }

    .game-ui {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .instructions {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      font-size: 14px;
    }

    .instructions h4 {
      margin: 0 0 10px 0;
      color: #6ea8ff;
    }

    .instructions ul {
      margin: 0;
      padding-left: 15px;
      color: #bbb;
    }

    .game-status {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .status-message {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .status-hint {
      font-size: 14px;
      color: #bbb;
      font-family: 'Courier New', monospace;
      background: #0f0f0f;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
    }

    .game-actions {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-btn {
      background: #6ea8ff;
      border: none;
      color: white;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      background: #4dabf7;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .pause-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .pause-menu {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
    }

    .particle {
      position: absolute;
      pointer-events: none;
      font-size: 16px;
      animation: particleFloat 1s ease-out forwards;
    }

    @keyframes particleFloat {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px);
      }
    }

    .combo-display {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(46, 204, 113, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      font-weight: bold;
      transform: scale(0);
      transition: transform 0.3s;
    }

    .combo-active {
      transform: scale(1);
    }

    @media (max-width: 768px) {
      .game-controls {
        grid-template-columns: 1fr;
      }
      .game-ui {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<script src="/js/arcade.js"></script>
<script>window.ghcMountHUD({ showHome:true });</script>
<body>
<header class="hud" id="hud"></header>

<div class="main-content">
  <h1>🧑‍🦲 Detached HEAD 대탈출</h1>
  <div class="sub">브랜치를 찾아 안전한 곳으로 착지하세요!</div>
  
  <div class="game-controls">
    <div class="control-panel">
      <div>점수</div>
      <div id="score" class="score-display">0</div>
    </div>
    <div class="control-panel">
      <div>생명</div>
      <div id="lives" class="lives-display">❤️❤️❤️</div>
    </div>
    <div class="control-panel">
      <div>레벨</div>
      <div id="level" class="level-display">1</div>
    </div>
  </div>

  <div class="game-area" id="game-area">
    <div class="ground"></div>
    <div id="head" class="head-player">👤</div>
    <div id="combo-display" class="combo-display">콤보 x0</div>
    <div id="pause-overlay" class="pause-overlay">
      <div class="pause-menu">
        <h2>⏸️ 게임 일시정지</h2>
        <p>스페이스바를 눌러 계속하기</p>
        <button class="action-btn" onclick="togglePause()">계속하기</button>
      </div>
    </div>
  </div>

  <div class="game-ui">
    <div class="instructions">
      <h4>🎮 조작법</h4>
      <ul>
        <li><kbd>스페이스</kbd> - 점프</li>
        <li><kbd>P</kbd> - 일시정지</li>
        <li><kbd>R</kbd> - 재시작</li>
        <li>🌿 브랜치 수집</li>
        <li>💀 장애물 피하기</li>
        <li>⭐ 파워업 수집</li>
      </ul>
    </div>

    <div class="game-status">
      <div id="status-message" class="status-message">스페이스바로 점프하며 브랜치를 찾으세요!</div>
      <div id="status-hint" class="status-hint">git checkout -b new-branch</div>
    </div>

    <div class="game-actions">
      <button class="action-btn" onclick="startGame()">🚀 게임 시작</button>
      <button class="action-btn" onclick="togglePause()">⏸️ 일시정지</button>
      <button class="action-btn" onclick="restartGame()">🔄 재시작</button>
    </div>
  </div>
</div>

<script>
  let gameState = {
    running: false,
    paused: false,
    score: 0,
    lives: 3,
    level: 1,
    combo: 0,
    speed: 2,
    jumpHeight: 120,
    isJumping: false,
    entities: []
  };

  let gameLoop;
  let spawnTimer;
  let difficultyTimer;

  function startGame() {
    if (gameState.running) return;
    
    gameState = {
      running: true,
      paused: false,
      score: 0,
      lives: 3,
      level: 1,
      combo: 0,
      speed: 2,
      jumpHeight: 120,
      isJumping: false,
      entities: []
    };
    
    updateDisplay();
    clearGameArea();
    
    gameLoop = setInterval(updateGame, 16);
    spawnTimer = setInterval(spawnEntity, 2000);
    difficultyTimer = setInterval(increaseDifficulty, 15000);
    
    updateStatus('게임 시작! 브랜치를 찾아 떠나세요!', 'git checkout main');
  }

  function updateGame() {
    if (!gameState.running || gameState.paused) return;
    
    moveEntities();
    checkCollisions();
    updateDisplay();
    
    if (gameState.lives <= 0) {
      endGame();
    }
  }

  function spawnEntity() {
    if (!gameState.running || gameState.paused) return;
    
    const gameArea = document.getElementById('game-area');
    const areaWidth = gameArea.offsetWidth;
    
    const entityTypes = [
      { emoji: '🌿', type: 'branch', class: 'branch', points: 10 },
      { emoji: '💀', type: 'obstacle', class: 'obstacle', damage: 1 },
      { emoji: '⭐', type: 'powerup', class: 'power-up', special: true },
      { emoji: '🔥', type: 'danger', class: 'obstacle', damage: 2 },
      { emoji: '💎', type: 'bonus', class: 'power-up', points: 50 }
    ];
    
    let selectedType;
    const rand = Math.random();
    
    if (rand < 0.4) {
      selectedType = entityTypes[0];
    } else if (rand < 0.7) {
      selectedType = entityTypes[1];
    } else if (rand < 0.85) {
      selectedType = entityTypes[2];
    } else if (rand < 0.95) {
      selectedType = entityTypes[3];
    } else {
      selectedType = entityTypes[4];
    }
    
    const entity = document.createElement('div');
    entity.className = selectedType.class;
    entity.textContent = selectedType.emoji;
    entity.style.left = areaWidth + 'px';
    entity.dataset.type = selectedType.type;
    entity.dataset.points = selectedType.points || 0;
    entity.dataset.damage = selectedType.damage || 0;
    entity.dataset.special = selectedType.special || false;
    
    gameArea.appendChild(entity);
    gameState.entities.push(entity);
  }

  function moveEntities() {
    gameState.entities.forEach((entity, index) => {
      const currentLeft = parseInt(entity.style.left);
      const newLeft = currentLeft - gameState.speed;
      
      if (newLeft < -50) {
        entity.remove();
        gameState.entities.splice(index, 1);
      } else {
        entity.style.left = newLeft + 'px';
      }
    });
  }

  function checkCollisions() {
    const head = document.getElementById('head');
    const headRect = head.getBoundingClientRect();
    
    gameState.entities.forEach((entity, index) => {
      const entityRect = entity.getBoundingClientRect();
      
      if (isColliding(headRect, entityRect)) {
        handleCollision(entity);
        entity.remove();
        gameState.entities.splice(index, 1);
      }
    });
  }

  function isColliding(rect1, rect2) {
    return !(rect1.right < rect2.left || 
             rect1.left > rect2.right || 
             rect1.bottom < rect2.top || 
             rect1.top > rect2.bottom);
  }

  function handleCollision(entity) {
    const type = entity.dataset.type;
    const points = parseInt(entity.dataset.points) || 0;
    const damage = parseInt(entity.dataset.damage) || 0;
    const special = entity.dataset.special === 'true';
    
    if (type === 'branch') {
      gameState.score += points + (gameState.combo * 2);
      gameState.combo++;
      updateCombo();
      createParticle(entity, '🌿 +' + (points + gameState.combo * 2), '#2ecc71');
      updateStatus('브랜치 발견! 안전한 착지!', 'git switch main');
      
      if (gameState.combo >= 5) {
        ghcUnlock('branch-hunter', '브랜치 헌터', 'good');
      }
      
    } else if (type === 'obstacle' || type === 'danger') {
      gameState.lives -= damage;
      gameState.combo = 0;
      updateCombo();
      createParticle(entity, '💥 -' + damage, '#e74c3c');
      updateStatus('충돌! HEAD가 손상되었습니다!', 'git reset --hard HEAD');
      
    } else if (special) {
      if (type === 'powerup') {
        gameState.lives = Math.min(5, gameState.lives + 1);
        gameState.score += 25;
        createParticle(entity, '⭐ +Life', '#f39c12');
        updateStatus('파워업! 생명력 회복!', 'git stash pop');
      } else if (type === 'bonus') {
        gameState.score += points * gameState.level;
        createParticle(entity, '💎 BONUS!', '#9b59b6');
        updateStatus('보너스 포인트!', 'git cherry-pick bonus');
      }
    }
    
    ghcAddScore(Math.floor(points / 10));
  }

  function createParticle(entity, text, color) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.textContent = text;
    particle.style.color = color;
    particle.style.left = entity.style.left;
    particle.style.bottom = '120px';
    
    document.getElementById('game-area').appendChild(particle);
    
    setTimeout(() => {
      particle.remove();
    }, 1000);
  }

  function updateCombo() {
    const comboDisplay = document.getElementById('combo-display');
    if (gameState.combo > 0) {
      comboDisplay.textContent = `콤보 x${gameState.combo}`;
      comboDisplay.classList.add('combo-active');
    } else {
      comboDisplay.classList.remove('combo-active');
    }
  }

  function jump() {
    if (gameState.isJumping) return;
    
    gameState.isJumping = true;
    const head = document.getElementById('head');
    head.classList.add('head-jumping');
    
    setTimeout(() => {
      head.classList.remove('head-jumping');
      gameState.isJumping = false;
    }, 600);
  }

  function increaseDifficulty() {
    if (!gameState.running) return;
    
    gameState.level++;
    gameState.speed += 0.5;
    
    updateStatus(`레벨 ${gameState.level}! 속도 증가!`, 'git rebase --interactive');
    
    clearInterval(spawnTimer);
    const newInterval = Math.max(800, 2000 - (gameState.level * 200));
    spawnTimer = setInterval(spawnEntity, newInterval);
  }

  function togglePause() {
    if (!gameState.running) return;
    
    gameState.paused = !gameState.paused;
    const overlay = document.getElementById('pause-overlay');
    overlay.style.display = gameState.paused ? 'flex' : 'none';
  }

  function restartGame() {
    endGame();
    setTimeout(startGame, 100);
  }

  function endGame() {
    gameState.running = false;
    clearInterval(gameLoop);
    clearInterval(spawnTimer);
    clearInterval(difficultyTimer);
    
    const finalScore = gameState.score;
    if (finalScore > 100) {
      updateStatus(`게임 오버! 최종 점수: ${finalScore}`, 'git log --oneline');
      ghcUnlock('survivor', 'HEAD 생존자', 'good');
    } else {
      updateStatus('게임 오버! 다시 도전해보세요!', 'git checkout -b try-again');
    }
    
    ghcAddScore(Math.floor(finalScore / 10));
  }

  function clearGameArea() {
    const gameArea = document.getElementById('game-area');
    gameState.entities.forEach(entity => entity.remove());
    gameState.entities = [];
    
    document.querySelectorAll('.particle').forEach(p => p.remove());
  }

  function updateDisplay() {
    document.getElementById('score').textContent = gameState.score;
    document.getElementById('lives').textContent = '❤️'.repeat(Math.max(0, gameState.lives));
    document.getElementById('level').textContent = gameState.level;
  }

  function updateStatus(message, hint) {
    document.getElementById('status-message').textContent = message;
    document.getElementById('status-hint').textContent = hint;
  }

  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      if (gameState.paused) {
        togglePause();
      } else {
        jump();
      }
    } else if (e.key === 'p' || e.key === 'P') {
      togglePause();
    } else if (e.key === 'r' || e.key === 'R') {
      restartGame();
    }
  });

  updateDisplay();
  updateStatus('스페이스바로 점프하며 브랜치를 찾으세요!', 'git checkout -b new-branch');
</script>
</body>
</html>