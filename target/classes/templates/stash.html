<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>📦 스태시 타임캡슐</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/arcade.css">
  
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Pretendard, sans-serif;
      margin: 0;
    }

    .main-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin: 20px 0;
      color: #fff;
    }

    .sub {
      text-align: center;
      color: #bbb;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .game-info {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .timer-display {
      font-size: 48px;
      font-weight: 900;
      color: #f39c12;
      margin: 10px 0;
    }

    .stash-vault {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 25px;
      margin: 25px 0;
    }

    .vault-title {
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
      font-size: 18px;
      color: #ddd;
    }

    .stash-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .stash-item {
      background: #232323;
      border: 2px solid #343434;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stash-item:hover {
      transform: translateY(-5px);
      border-color: #555;
    }

    .stash-item.selected {
      border-color: #f39c12;
      background: #2a1f0f;
      transform: translateY(-5px);
    }

    .stash-item.correct {
      border-color: #2ecc71;
      background: #0f2a1f;
    }

    .stash-item.wrong {
      border-color: #e74c3c;
      background: #2a0f0f;
    }

    .stash-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .stash-id {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: #f39c12;
      background: #0f0f0f;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }

    .stash-age {
      font-size: 12px;
      color: #888;
      background: #1a1a1a;
      padding: 3px 6px;
      border-radius: 3px;
    }

    .stash-message {
      font-size: 16px;
      margin: 12px 0;
      line-height: 1.4;
    }

    .stash-preview {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #777;
      background: #0f0f0f;
      padding: 8px;
      border-radius: 4px;
      border-left: 3px solid #444;
      margin-top: 8px;
    }

    .action-area {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 25px;
      margin: 25px 0;
      text-align: center;
    }

    .difficulty-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .difficulty-btn {
      padding: 12px;
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .difficulty-btn:hover {
      background: #444;
    }

    .difficulty-btn.active {
      background: #f39c12;
      border-color: #e67e22;
      color: #000;
      font-weight: bold;
    }

    .start-btn {
      background: #f39c12;
      border: none;
      color: white;
      padding: 18px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      margin: 20px 0;
      transition: all 0.2s;
    }

    .start-btn:hover {
      transform: translateY(-2px);
      background: #e67e22;
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .result-panel {
      background: #181818;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 25px;
      margin: 25px 0;
    }

    .result-avatar {
      font-size: 80px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .result-message {
      font-size: 20px;
      text-align: center;
      margin: 15px 0;
      font-weight: 600;
    }

    .result-hint {
      font-size: 14px;
      color: #bbb;
      text-align: center;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      background: #0f0f0f;
      padding: 10px;
      border-radius: 6px;
    }

    .score-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      padding: 15px;
      border-radius: 8px;
      background: #222;
    }

    .score-positive { color: #2ecc71; }
    .score-negative { color: #e74c3c; }
    .score-neutral { color: #bbb; }

    .game-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: #232323;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .stash-grid {
        grid-template-columns: 1fr;
      }
      .difficulty-selector {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<script src="/js/arcade.js"></script>
<script>window.ghcMountHUD({ showHome:true });</script>
<body>
<header class="hud" id="hud"></header>

<div class="main-content">
  <h1>📦 스태시 타임캡슐</h1>
  <div class="sub">묻어둔 코드 중에서 살릴 만한 것을 찾아보세요</div>

  <div class="game-info">
    <div>⏱️ 제한시간</div>
    <div id="timer" class="timer-display">30</div>
    <div style="color: #bbb;">올바른 스태시만 선택하세요!</div>
  </div>

  <div class="action-area">
    <h3>🎯 난이도 선택</h3>
    <div class="difficulty-selector">
      <button class="difficulty-btn active" data-difficulty="easy">
        🟢 쉬움<br><small>명확한 구분</small>
      </button>
      <button class="difficulty-btn" data-difficulty="medium">
        🟡 보통<br><small>약간의 함정</small>
      </button>
      <button class="difficulty-btn" data-difficulty="hard">
        🔴 어려움<br><small>교묘한 덫</small>
      </button>
    </div>
    <button class="start-btn" id="start-btn">🚀 게임 시작!</button>
  </div>

  <div class="stash-vault" id="stash-vault" style="display: none;">
    <div class="vault-title">📚 스태시 보관함</div>
    <div id="stash-grid" class="stash-grid"></div>
  </div>

  <div class="result-panel" id="result-panel" style="display: none;">
    <div id="result-avatar" class="result-avatar">🧑‍💻</div>
    <div id="result-message" class="result-message">게임을 시작하세요!</div>
    <div id="result-hint" class="result-hint"></div>
    <div id="score-display" class="score-display score-neutral">점수: 0</div>
    
    <div class="game-stats">
      <div class="stat-card">
        <div class="stat-label">정확도</div>
        <div id="accuracy" class="stat-value">-%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">선택한 스태시</div>
        <div id="selected-count" class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">남은 시간</div>
        <div id="time-left" class="stat-value">30s</div>
      </div>
    </div>
  </div>
</div>

<script>
  let gameState = {
    running: false,
    paused: false,
    score: 0,
    lives: 3,
    level: 1,
    combo: 0,
    speed: 2,
    jumpHeight: 120,
    isJumping: false,
    entities: []
  };

  let timeLeft = 30;
  let selectedStashes = [];
  let correctStashes = [];
  let currentDifficulty = 'easy';
  let gameTimer;

  const stashData = {
    easy: [
      { id: "stash@{0}", message: "Fix critical login bug", preview: "- auth.validate(user)", good: true, age: "2일 전" },
      { id: "stash@{1}", message: "Temp debugging code", preview: "+ console.log('debug')", good: false, age: "1주 전" },
      { id: "stash@{2}", message: "Update README typo", preview: "- documnetation\n+ documentation", good: false, age: "3일 전" },
      { id: "stash@{3}", message: "Fix NPE in payment", preview: "+ if (payment != null)", good: true, age: "1일 전" },
      { id: "stash@{4}", message: "Add debug prints", preview: "+ System.out.println", good: false, age: "5일 전" },
      { id: "stash@{5}", message: "Hotfix user session", preview: "- session.expired()", good: true, age: "6시간 전" }
    ],
    medium: [
      { id: "stash@{0}", message: "Performance optimization", preview: "- O(n²) → O(n log n)", good: true, age: "1일 전" },
      { id: "stash@{1}", message: "CSS margin tweak", preview: ".margin { top: 5px }", good: false, age: "2주 전" },
      { id: "stash@{2}", message: "Security patch CVE-2024", preview: "+ input.sanitize()", good: true, age: "3시간 전" },
      { id: "stash@{3}", message: "Remove old comments", preview: "- // TODO: fix later", good: false, age: "1개월 전" },
      { id: "stash@{4}", message: "Database connection fix", preview: "+ conn.setAutoCommit(false)", good: true, age: "8시간 전" },
      { id: "stash@{5}", message: "Lint formatting", preview: "- tabs → spaces", good: false, age: "2일 전" }
    ],
    hard: [
      { id: "stash@{0}", message: "Refactor user model", preview: "± class User extends Model", good: true, age: "12시간 전" },
      { id: "stash@{1}", message: "Update package.json", preview: "+ react@18.2.0", good: false, age: "3주 전" },
      { id: "stash@{2}", message: "Fix race condition", preview: "+ synchronized(lock)", good: true, age: "2시간 전" },
      { id: "stash@{3}", message: "Add error logging", preview: "+ logger.error(ex)", good: false, age: "1주 전" },
      { id: "stash@{4}", message: "Memory leak patch", preview: "- static List<Object>", good: true, age: "4시간 전" },
      { id: "stash@{5}", message: "Code style cleanup", preview: "- var → const", good: false, age: "10일 전" }
    ]
  };

  function selectDifficulty(difficulty) {
    currentDifficulty = difficulty;
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('active');
  }

  function startGame() {
    gameState.running = true;
    timeLeft = 30;
    selectedStashes = [];
    
    const data = stashData[currentDifficulty];
    correctStashes = data.filter(s => s.good).map(s => s.id);
    
    document.getElementById('stash-vault').style.display = 'block';
    document.getElementById('result-panel').style.display = 'block';
    document.getElementById('start-btn').disabled = true;
    
    renderStashes(data);
    startTimer();
    updateStats();
  }

  function renderStashes(data) {
    const grid = document.getElementById('stash-grid');
    grid.innerHTML = data.map(stash => `
      <div class="stash-item" data-id="${stash.id}" onclick="selectStash('${stash.id}')">
        <div class="stash-header">
          <div class="stash-id">${stash.id}</div>
          <div class="stash-age">${stash.age}</div>
        </div>
        <div class="stash-message">${stash.message}</div>
        <div class="stash-preview">${stash.preview}</div>
      </div>
    `).join('');
  }

  function selectStash(stashId) {
    if (!gameState.running) return;
    
    const element = document.querySelector(`[data-id="${stashId}"]`);
    
    if (selectedStashes.includes(stashId)) {
      selectedStashes = selectedStashes.filter(id => id !== stashId);
      element.classList.remove('selected');
    } else {
      selectedStashes.push(stashId);
      element.classList.add('selected');
    }
    
    updateStats();
  }

  function startTimer() {
    gameTimer = setInterval(() => {
      timeLeft--;
      document.getElementById('timer').textContent = timeLeft;
      document.getElementById('time-left').textContent = timeLeft + 's';
      
      if (timeLeft <= 0) {
        endGame();
      }
    }, 1000);
  }

  function endGame() {
    gameState.running = false;
    clearInterval(gameTimer);
    
    const correctlySelected = selectedStashes.filter(id => correctStashes.includes(id)).length;
    const incorrectlySelected = selectedStashes.filter(id => !correctStashes.includes(id)).length;
    const missed = correctStashes.filter(id => !selectedStashes.includes(id)).length;
    
    const accuracy = selectedStashes.length > 0 ? Math.round((correctlySelected / selectedStashes.length) * 100) : 0;
    const score = (correctlySelected * 20) - (incorrectlySelected * 10) - (missed * 5);
    
    document.querySelectorAll('.stash-item').forEach(item => {
      const id = item.dataset.id;
      if (correctStashes.includes(id)) {
        item.classList.add('correct');
      } else if (selectedStashes.includes(id)) {
        item.classList.add('wrong');
      }
    });
    
    updateResult(score, accuracy, correctlySelected, incorrectlySelected, missed);
    
    setTimeout(() => {
      document.getElementById('start-btn').disabled = false;
      document.getElementById('start-btn').textContent = '🔄 다시 시작';
    }, 2000);
  }

  function updateResult(score, accuracy, correct, incorrect, missed) {
    const avatar = document.getElementById('result-avatar');
    const message = document.getElementById('result-message');
    const hint = document.getElementById('result-hint');
    const scoreDisplay = document.getElementById('score-display');
    
    if (score >= 40) {
      avatar.textContent = '🏆';
      message.textContent = '완벽한 스태시 마스터!';
      hint.textContent = 'git stash apply stash@{n} --index';
    } else if (score >= 20) {
      avatar.textContent = '😎';
      message.textContent = '괜찮은 선택이었습니다!';
      hint.textContent = 'git stash list | grep -E "(fix|bug|patch)"';
    } else if (score >= 0) {
      avatar.textContent = '😐';
      message.textContent = '아직 연습이 더 필요해요';
      hint.textContent = 'git stash show -p stash@{n}';
    } else {
      avatar.textContent = '😡';
      message.textContent = '코드가 더 망가졌어요...';
      hint.textContent = 'git stash drop stash@{n}';
    }
    
    scoreDisplay.textContent = `점수: ${score > 0 ? '+' : ''}${score}`;
    scoreDisplay.className = `score-display ${score > 0 ? 'score-positive' : score < 0 ? 'score-negative' : 'score-neutral'}`;
    
    document.getElementById('accuracy').textContent = accuracy + '%';
    
    if (score !== 0) {
      ghcAddScore(score);
    }
  }

  function updateStats() {
    document.getElementById('selected-count').textContent = selectedStashes.length;
    document.getElementById('time-left').textContent = timeLeft + 's';
  }

  document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectDifficulty(btn.dataset.difficulty);
    });
  });

  document.getElementById('start-btn').addEventListener('click', startGame);
</script>
</body>
</html>