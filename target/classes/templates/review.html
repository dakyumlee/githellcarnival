<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>🤡 코드 리뷰 전쟁터</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/arcade.css">
  
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Pretendard, sans-serif;
      margin: 0;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin: 0 0 8px;
      font-size: 2.8rem;
      color: #fff;
    }

    .sub {
      text-align: center;
      color: #bbb;
      margin-bottom: 20px;
      font-size: 16px;
    }

    .battlefield {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin: 20px 0;
    }

    .editor-panel {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .panel-title {
      font-weight: 700;
      font-size: 18px;
      color: #ddd;
    }

    .battle-timer {
      background: #e74c3c;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 16px;
    }

    #editor {
      height: 500px;
      border: 1px solid #333;
      border-radius: 10px;
      overflow: hidden;
    }

    .code-templates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 15px 0;
    }

    .template-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .template-btn:hover {
      background: #444;
      transform: translateY(-1px);
    }

    .submit-area {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-top: 15px;
    }

    .submit-btn {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      background: #c0392b;
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .auto-review-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .auto-review-toggle input[type=checkbox] {
      width: 16px;
      height: 16px;
      accent-color: #6ea8ff;
    }

    .stats-panel {
      background: #181818;
      border: 1px solid #333;
      border-radius: 15px;
      padding: 20px;
    }

    .rage-meters {
      margin: 20px 0;
    }

    .meter-group {
      margin: 15px 0;
    }

    .meter-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .meter-bar {
      height: 12px;
      background: #2a2a2a;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .meter-fill {
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 6px;
    }

    .meter-readability .meter-fill {
      background: #2ecc71;
    }

    .meter-performance .meter-fill {
      background: #3498db;
    }

    .meter-ai-anger .meter-fill {
      background: #e74c3c;
    }

    .ai-avatar {
      font-size: 80px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s ease;
    }

    .battle-result {
      background: #232323;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }

    .result-message {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .result-score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }

    .score-positive { color: #2ecc71; }
    .score-negative { color: #e74c3c; }
    .score-neutral { color: #bbb; }

    .refactor-tips {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      max-height: 150px;
      overflow-y: auto;
    }

    .tips-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #ddd;
    }

    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .tips-list li {
      padding: 4px 0;
      font-size: 13px;
      color: #bbb;
      border-left: 2px solid #6ea8ff;
      padding-left: 8px;
      margin: 4px 0;
    }

    .code-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 15px 0;
    }

    .stat-item {
      background: #232323;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }

    .stat-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
    }

    .challenge-mode {
      background: #2a1810;
      border: 1px solid #8b4513;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }

    @media (max-width: 1024px) {
      .battlefield {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<script src="/js/arcade.js"></script>
<script>window.ghcMountHUD({ showHome:true });</script>
<body>
<header class="hud" id="hud"></header>

<div class="main-content">
  <h1>🤡 코드 리뷰 전쟁터</h1>
  <div class="sub">AI 리뷰봇과의 치열한 리팩토링 배틀</div>

  <div class="challenge-mode" id="challenge-mode">
    <div>⚡ 챌린지 모드: 60초 안에 모든 지표를 80점 이상으로!</div>
    <div style="font-size: 12px; color: #bbb; margin-top: 5px;">실패 시 -50점 페널티</div>
  </div>

  <div class="battlefield">
    <div class="editor-panel">
      <div class="panel-header">
        <div class="panel-title">💻 코드 에디터</div>
        <div id="battle-timer" class="battle-timer">60s</div>
      </div>
      
      <div class="code-templates">
        <button class="template-btn" onclick="loadTemplate('basic')">🎯 기본 문제</button>
        <button class="template-btn" onclick="loadTemplate('nightmare')">👹 지옥 문제</button>
        <button class="template-btn" onclick="loadTemplate('legacy')">💀 레거시</button>
      </div>

      <div id="editor"></div>

      <div class="submit-area">
        <button class="submit-btn" id="review-btn" onclick="requestReview()">
          🔍 AI 리뷰 요청
        </button>
        <div class="auto-review-toggle">
          <input type="checkbox" id="auto-review" onchange="toggleAutoReview()">
          <label for="auto-review">실시간 리뷰</label>
        </div>
      </div>
    </div>

    <div class="stats-panel">
      <div class="panel-title">📊 전투 현황</div>

      <div class="rage-meters">
        <div class="meter-group meter-readability">
          <div class="meter-label">
            <span>가독성</span>
            <span id="readability-value">0</span>
          </div>
          <div class="meter-bar">
            <div id="readability-fill" class="meter-fill" style="width: 0%"></div>
          </div>
        </div>

        <div class="meter-group meter-performance">
          <div class="meter-label">
            <span>성능</span>
            <span id="performance-value">0</span>
          </div>
          <div class="meter-bar">
            <div id="performance-fill" class="meter-fill" style="width: 0%"></div>
          </div>
        </div>

        <div class="meter-group meter-ai-anger">
          <div class="meter-label">
            <span>AI 분노도</span>
            <span id="ai-anger-value">0</span>
          </div>
          <div class="meter-bar">
            <div id="ai-anger-fill" class="meter-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div id="ai-avatar" class="ai-avatar">🤖</div>

      <div class="battle-result" id="battle-result">
        <div id="result-message" class="result-message">코드를 작성하고 리뷰를 요청하세요!</div>
        <div id="result-score" class="result-score score-neutral">점수: 대기중</div>
      </div>

      <div class="code-stats">
        <div class="stat-item">
          <div class="stat-label">코드 라인</div>
          <div id="line-count" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">함수 개수</div>
          <div id="function-count" class="stat-value">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">복잡도</div>
          <div id="complexity" class="stat-value">1</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">리뷰 횟수</div>
          <div id="review-count" class="stat-value">0</div>
        </div>
      </div>

      <div class="refactor-tips">
        <div class="tips-title">🛠️ 리팩토링 제안</div>
        <ul id="tips-list" class="tips-list">
          <li>코드를 분석하면 제안이 나타납니다</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  let editor;
  let autoReviewTimer;
  let challengeTimer;
  let challengeActive = false;
  let reviewCount = 0;
  let timeLeft = 60;

  const codeTemplates = {
    basic: `public class Calculator {
    public static void main(String[] args) {
        int sum = 0;
        for(int i = 0; i < 100; i++) {
            for(int j = 0; j < 50; j++) {
                sum += i * j;
            }
        }
        if(sum > 0) {
            if(sum % 2 == 0) {
                System.out.println("even");
            } else {
                System.out.println("odd");
            }
        }
    }
}`,
    nightmare: `public class DataProcessor {
    public static void processData(String data) {
        String[] parts = data.split(",");
        List<String> results = new ArrayList<>();
        for(int i = 0; i < parts.length; i++) {
            if(parts[i] != null) {
                if(!parts[i].isEmpty()) {
                    if(parts[i].contains("@")) {
                        if(parts[i].indexOf("@") > 0) {
                            if(parts[i].substring(parts[i].indexOf("@")).contains(".")) {
                                String processed = parts[i].toLowerCase().trim();
                                if(processed.length() > 5) {
                                    for(int j = 0; j < processed.length(); j++) {
                                        if(Character.isDigit(processed.charAt(j))) {
                                            processed = processed.substring(0, j) + "*" + processed.substring(j + 1);
                                        }
                                    }
                                    results.add(processed);
                                }
                            }
                        }
                    }
                }
            }
        }
        System.out.println(results.toString());
    }
}`,
    legacy: `public class LegacySystem {
    public static Map processRequest(String req, String type, boolean flag, int mode) {
        Map result = new HashMap();
        String[] data = req.split(";");
        for(int i = 0; i < data.length; i++) {
            String item = data[i];
            if(type.equals("A")) {
                if(flag) {
                    if(mode == 1) {
                        result.put("key" + i, item.toUpperCase());
                    } else if(mode == 2) {
                        result.put("key" + i, item.toLowerCase());
                    } else {
                        result.put("key" + i, item);
                    }
                } else {
                    result.put("key" + i, item.trim());
                }
            } else if(type.equals("B")) {
                result.put("data_" + i, item.length());
            } else {
                result.put(i, item.hashCode());
            }
        }
        return result;
    }
}`
  };

  require.config({
    paths: {
      'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'
    }
  });

  require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor'), {
      value: codeTemplates.basic,
      language: "java",
      theme: "vs-dark",
      automaticLayout: true,
      lineNumbers: 'on',
      minimap: { enabled: false },
      scrollBeyondLastLine: false
    });

    editor.onDidChangeModelContent(() => {
      updateCodeStats();
      if (document.getElementById('auto-review').checked) {
        debounceAutoReview();
      }
    });

    startChallenge();
  });

  function loadTemplate(templateName) {
    if (editor && codeTemplates[templateName]) {
      editor.setValue(codeTemplates[templateName]);
      updateCodeStats();
    }
  }

  function updateCodeStats() {
    const code = editor.getValue();
    const lines = code.split('\n').length;
    const functionCount = (code.match(/public\s+\w+\s+\w+\s*\(/g) || []).length;
    const complexity = calculateComplexity(code);

    document.getElementById('line-count').textContent = lines;
    document.getElementById('function-count').textContent = functionCount;
    document.getElementById('complexity').textContent = complexity;
  }

  function calculateComplexity(code) {
    let complexity = 1;
    const patterns = ['if\\s*\\(', 'while\\s*\\(', 'for\\s*\\(', 'catch\\s*\\(', '\\?\\s*:', '&&', '\\|\\|'];
    patterns.forEach(pattern => {
      const matches = code.match(new RegExp(pattern, 'g'));
      if (matches) complexity += matches.length;
    });
    return complexity;
  }

  function debounceAutoReview() {
    clearTimeout(autoReviewTimer);
    autoReviewTimer = setTimeout(requestReview, 1500);
  }

  function toggleAutoReview() {
    const isEnabled = document.getElementById('auto-review').checked;
    if (!isEnabled) {
      clearTimeout(autoReviewTimer);
    }
  }

  function requestReview() {
    const reviewBtn = document.getElementById('review-btn');
    reviewBtn.disabled = true;
    reviewBtn.textContent = '🔄 분석중...';

    reviewCount++;
    document.getElementById('review-count').textContent = reviewCount;

    fetch("/api/review/analyze", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({code: editor.getValue()})
    })
    .then(r => r.json())
    .then(data => {
      updateBattleResult(data);
      
      setTimeout(() => {
        reviewBtn.disabled = false;
        reviewBtn.textContent = '🔍 AI 리뷰 요청';
      }, 1000);
    })
    .catch(() => {
      reviewBtn.disabled = false;
      reviewBtn.textContent = '🔍 AI 리뷰 요청';
    });
  }

  function updateBattleResult(data) {
    updateMeter('readability', data.readability);
    updateMeter('performance', data.performance);
    updateMeter('ai-anger', data.aiAnger);

    const avatar = document.getElementById('ai-avatar');
    const message = document.getElementById('result-message');
    const score = document.getElementById('result-score');

    if (data.aiAnger < 30) {
      avatar.textContent = '😊';
    } else if (data.aiAnger < 60) {
      avatar.textContent = '😐';
    } else if (data.aiAnger < 80) {
      avatar.textContent = '😠';
    } else {
      avatar.textContent = '🤬';
    }

    message.textContent = data.message;

    const totalScore = calculateBattleScore(data);
    score.textContent = `전투 점수: ${totalScore}`;
    score.className = `result-score ${totalScore > 0 ? 'score-positive' : totalScore < 0 ? 'score-negative' : 'score-neutral'}`;

    updateTips(data.tips || []);

    if (challengeActive) {
      checkChallengeComplete(data);
    }

    if (totalScore !== 0) {
      ghcAddScore(totalScore);
    }
  }

  function updateMeter(type, value) {
    const valueEl = document.getElementById(`${type}-value`);
    const fillEl = document.getElementById(`${type}-fill`);
    
    valueEl.textContent = value;
    fillEl.style.width = Math.min(100, Math.max(0, value)) + '%';
  }

  function updateTips(tips) {
    const tipsList = document.getElementById('tips-list');
    if (tips.length === 0) {
      tipsList.innerHTML = '<li>코드가 깔끔합니다! 👍</li>';
    } else {
      tipsList.innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
    }
  }

  function calculateBattleScore(data) {
    let score = 0;
    
    score += Math.max(0, data.readability - 50) * 0.5;
    score += Math.max(0, data.performance - 50) * 0.5;
    score -= Math.max(0, data.aiAnger - 30) * 0.8;
    
    if (challengeActive && data.readability >= 80 && data.performance >= 80 && data.aiAnger <= 20) {
      score += 100;
    }
    
    if (reviewCount > 5) {
      score -= (reviewCount - 5) * 5;
    }
    
    return Math.round(score);
  }

  function startChallenge() {
    challengeActive = true;
    timeLeft = 60;
    reviewCount = 0;
    
    document.getElementById('review-count').textContent = '0';
    
    challengeTimer = setInterval(() => {
      timeLeft--;
      document.getElementById('battle-timer').textContent = timeLeft + 's';
      
      if (timeLeft <= 0) {
        endChallenge(false);
      }
    }, 1000);
  }

  function checkChallengeComplete(data) {
    if (data.readability >= 80 && data.performance >= 80 && data.aiAnger <= 20) {
      endChallenge(true);
    }
  }

  function endChallenge(success) {
    challengeActive = false;
    clearInterval(challengeTimer);
    
    const message = document.getElementById('result-message');
    
    if (success) {
      message.textContent = '🏆 챌린지 성공! 완벽한 리팩토링!';
      ghcAddScore(200);
      ghcUnlock('refactor-master', '리팩토링 마스터', 'good');
    } else {
      message.textContent = '⏰ 시간 초과! 챌린지 실패...';
      ghcAddScore(-50);
    }
    
    setTimeout(() => {
      startChallenge();
    }, 3000);
  }

  updateCodeStats();
</script>
</body>
</html>