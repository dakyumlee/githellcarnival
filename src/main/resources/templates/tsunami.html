<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>🌊 Revert 쓰나미</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #0f1419 !important;
      color: #e6f1ff !important;
      font-family: 'Pretendard', sans-serif !important;
      min-height: 100vh;
    }
    
    .custom-hud {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(15, 20, 25, 0.95) !important;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid #2563eb;
    }
    
    .custom-logo {
      font-weight: 900;
      color: #3b82f6 !important;
      font-size: 1.2rem;
    }
    
    .custom-home {
      background: #1e293b !important;
      border: 1px solid #2563eb !important;
      color: #e6f1ff !important;
      border-radius: 10px;
      padding: 8px 12px;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .custom-home:hover {
      background: #334155 !important;
      transform: translateY(-2px);
    }
    
    .game-container {
      text-align: center;
      padding: 2rem;
      background: #0f1419 !important;
      color: #e6f1ff !important;
      min-height: calc(100vh - 80px);
    }
    
    .game-title {
      font-size: 3rem !important;
      color: #3b82f6 !important;
      margin-bottom: 1rem !important;
      font-weight: 900 !important;
    }
    
    .game-subtitle {
      font-size: 1.2rem !important;
      color: #94a3b8 !important;
      margin-bottom: 2rem !important;
    }
    
    .game-area {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
      height: 400px;
      background: #1e293b !important;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #334155;
    }
    
    .player {
      position: absolute !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      font-size: 3rem !important;
      z-index: 20 !important;
    }
    
    .stats-grid {
      margin: 2rem 0;
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: #1e293b !important;
      padding: 1rem;
      border-radius: 10px;
      min-width: 120px;
      border: 1px solid #334155;
    }
    
    .stat-label {
      font-weight: bold !important;
      color: #94a3b8 !important;
      margin-bottom: 0.5rem;
    }
    
    .stat-value {
      font-size: 1.5rem !important;
      color: #3b82f6 !important;
      font-weight: 700 !important;
    }
    
    .game-buttons {
      margin: 2rem 0;
    }
    
    .btn-primary {
      background: #3b82f6 !important;
      color: white !important;
      border: none !important;
      padding: 1rem 2rem !important;
      font-size: 1.1rem !important;
      border-radius: 10px !important;
      cursor: pointer !important;
      margin-right: 1rem !important;
      transition: all 0.3s ease !important;
      font-weight: 600 !important;
    }
    
    .btn-primary:hover {
      background: #1d4ed8 !important;
      transform: translateY(-2px) !important;
    }
    
    .btn-secondary {
      background: #334155 !important;
      color: white !important;
      border: none !important;
      padding: 1rem 2rem !important;
      font-size: 1.1rem !important;
      border-radius: 10px !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      font-weight: 600 !important;
    }
    
    .btn-secondary:hover {
      background: #475569 !important;
    }
    
    .btn-secondary:disabled {
      opacity: 0.5 !important;
      cursor: not-allowed !important;
    }
    
    .game-message {
      margin-top: 1rem;
      font-size: 1.1rem !important;
      min-height: 1.5rem;
      font-weight: 600 !important;
    }
    
    .game-instructions {
      margin-top: 2rem;
      color: #94a3b8 !important;
    }
    
    .commit-item {
      position: absolute !important;
      padding: 8px 12px !important;
      border-radius: 5px !important;
      cursor: pointer !important;
      font-size: 0.9rem !important;
      font-weight: bold !important;
      transition: all 0.2s !important;
      z-index: 10 !important;
      color: black !important;
    }
    
    .commit-good {
      background: #00ff41 !important;
    }
    
    .commit-bad {
      background: #ff6b6b !important;
    }
  </style>
</head>
<script src="/js/arcade.js"></script>
<script>
if(window.ghcMountHUD) {
  window.ghcMountHUD({ showHome:true });
}
</script>
<body>
  <header class="custom-hud">
    <div style="display: flex; gap: 12px; align-items: center;">
      <a class="custom-home" href="/">← 로비</a>
      <div class="custom-logo">GHC</div>
    </div>
  </header>
  
  <div class="game-container">
    <h1 class="game-title">🌊 Revert 쓰나미</h1>
    <p class="game-subtitle">나쁜 커밋을 클릭해서 revert하세요!</p>
    
    <div class="game-area" id="game-area">
      <div id="commits-container" style="position: relative; width: 100%; height: 100%;"></div>
      <div class="player" id="player">🧑‍💻</div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">점수</div>
        <div class="stat-value" id="score">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">생명</div>
        <div class="stat-value" id="lives">❤️❤️❤️</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">웨이브</div>
        <div class="stat-value" id="wave">1</div>
      </div>
    </div>
    
    <div class="game-buttons">
      <button class="btn-primary" id="start-btn" onclick="startGame()">게임 시작</button>
      <button class="btn-secondary" id="pause-btn" onclick="pauseGame()" disabled>일시정지</button>
    </div>
    
    <div class="game-message" id="message"></div>
    
    <div class="game-instructions">
      <p>← → 화살표키로 이동, 나쁜 커밋(빨간색)을 클릭하세요!</p>
      <p>좋은 커밋(초록색)은 피하세요!</p>
    </div>
  </div>
  
  <script>
    let gameState = {
      isRunning: false,
      isPaused: false,
      score: 0,
      lives: 3,
      wave: 1,
      playerX: 50,
      commits: [],
      gameLoop: null,
      spawnTimer: null
    };

    const commitTypes = {
      good: [
        { message: "feat: add authentication", class: "commit-good" },
        { message: "fix: memory leak", class: "commit-good" },
        { message: "docs: update README", class: "commit-good" },
        { message: "test: add unit tests", class: "commit-good" }
      ],
      bad: [
        { message: "console.log everywhere", class: "commit-bad" },
        { message: "quick fix dont review", class: "commit-bad" },
        { message: "TODO: fix later", class: "commit-bad" },
        { message: "untested hotfix", class: "commit-bad" }
      ]
    };

    function updateUI() {
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('wave').textContent = gameState.wave;
      document.getElementById('lives').innerHTML = '❤️'.repeat(gameState.lives) + '🖤'.repeat(3 - gameState.lives);
    }

    function createCommit() {
      const isGood = Math.random() > 0.6;
      const type = isGood ? 'good' : 'bad';
      const templates = commitTypes[type];
      const template = templates[Math.floor(Math.random() * templates.length)];
      
      const commit = document.createElement('div');
      commit.className = `commit-item ${template.class}`;
      commit.dataset.type = type;
      commit.style.top = '-50px';
      commit.style.left = (Math.random() * 80 + 10) + '%';
      commit.textContent = template.message;
      
      commit.addEventListener('click', () => handleCommitClick(commit, type));
      
      document.getElementById('commits-container').appendChild(commit);
      gameState.commits.push(commit);
    }

    function handleCommitClick(commit, type) {
      commit.remove();
      gameState.commits = gameState.commits.filter(c => c !== commit);
      
      const data = {
        wave: gameState.wave,
        score: gameState.score,
        combo: 0,
        action: "click",
        commitType: type
      };
      
      fetch('/api/tsunami/click', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          gameState.score += result.scoreGain || 10;
          document.getElementById('message').textContent = result.message;
          document.getElementById('message').style.color = '#00ff41';
        } else {
          gameState.lives--;
          document.getElementById('message').textContent = result.message;
          document.getElementById('message').style.color = '#ff6b6b';
          
          if (gameState.lives <= 0) {
            endGame();
          }
        }
        updateUI();
      })
      .catch(() => {
        document.getElementById('message').textContent = "API 연결 실패";
        document.getElementById('message').style.color = '#ff6b6b';
      });
    }

    function moveCommits() {
      if (!gameState.isRunning || gameState.isPaused) return;
      
      gameState.commits.forEach((commit, index) => {
        if (!commit.parentNode) return;
        
        const currentTop = parseInt(commit.style.top) || -50;
        const newTop = currentTop + 2;
        
        if (newTop > 400) {
          if (commit.dataset.type === 'bad') {
            gameState.lives--;
            document.getElementById('message').textContent = "나쁜 커밋이 통과했습니다!";
            document.getElementById('message').style.color = '#ff6b6b';
            
            if (gameState.lives <= 0) {
              endGame();
              return;
            }
          }
          
          commit.remove();
          gameState.commits.splice(index, 1);
          updateUI();
        } else {
          commit.style.top = newTop + 'px';
        }
      });
    }

    function startGame() {
      gameState = {
        isRunning: true,
        isPaused: false,
        score: 0,
        lives: 3,
        wave: 1,
        playerX: 50,
        commits: [],
        gameLoop: null,
        spawnTimer: null
      };
      
      document.getElementById('commits-container').innerHTML = '';
      document.getElementById('start-btn').disabled = true;
      document.getElementById('pause-btn').disabled = false;
      document.getElementById('message').textContent = "게임 시작!";
      document.getElementById('message').style.color = '#3b82f6';
      
      updateUI();
      
      gameState.gameLoop = setInterval(moveCommits, 50);
      gameState.spawnTimer = setInterval(createCommit, 2000);
      
      fetch('/api/tsunami/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({wave: 1, score: 0, combo: 0, action: "start"})
      }).catch(() => {
        document.getElementById('message').textContent = "API 연결 실패 - 오프라인 모드";
        document.getElementById('message').style.color = '#ffa500';
      });
    }

    function pauseGame() {
      gameState.isPaused = !gameState.isPaused;
      document.getElementById('pause-btn').textContent = gameState.isPaused ? '계속' : '일시정지';
    }

    function endGame() {
      gameState.isRunning = false;
      clearInterval(gameState.gameLoop);
      clearInterval(gameState.spawnTimer);
      
      document.getElementById('start-btn').disabled = false;
      document.getElementById('pause-btn').disabled = true;
      document.getElementById('pause-btn').textContent = '일시정지';
      
      const data = {
        wave: gameState.wave,
        score: gameState.score,
        combo: 0,
        action: "end"
      };
      
      fetch('/api/tsunami/end', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(result => {
        document.getElementById('message').textContent = `게임 종료! ${result.message} (${result.rank})`;
        document.getElementById('message').style.color = '#3b82f6';
        
        if (window.ghcAddScore) {
          window.ghcAddScore(result.scoreDiff || 0);
        }
      })
      .catch(() => {
        document.getElementById('message').textContent = `게임 종료! 최종 점수: ${gameState.score}`;
        document.getElementById('message').style.color = '#3b82f6';
      });
    }

    document.addEventListener('keydown', (e) => {
      if (!gameState.isRunning || gameState.isPaused) return;
      
      const player = document.getElementById('player');
      if (e.key === 'ArrowLeft') {
        gameState.playerX = Math.max(5, gameState.playerX - 5);
        player.style.left = gameState.playerX + '%';
      } else if (e.key === 'ArrowRight') {
        gameState.playerX = Math.min(95, gameState.playerX + 5);
        player.style.left = gameState.playerX + '%';
      }
    });

    updateUI();
  </script>
</body>
</html>